<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroWall SarifViewer - Offline SARIF Security Report Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #121315;
            min-height: 100vh;
            padding: 20px;
            color: #b3b3b3;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1a1b1f;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid #2a2b31;
        }

        .header {
            background: linear-gradient(135deg, #1e1f23 0%, #252731 100%);
            color: #e6e6e6;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iMjAiIGZpbGw9IiMxZTFmMjMiLz4KPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMzAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzM5OWZmNiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjE1IiBmaWxsPSIjMzk5ZmY2Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUiIGZpbGw9IiNmZmZmZmYiLz4KPC9zdmc+') no-repeat center center;
            background-size: contain;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .powered-by {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #7a7a8a;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .powered-by a {
            color: #399ff6;
            text-decoration: none;
            font-weight: 600;
        }

        .powered-by a:hover {
            text-decoration: underline;
        }

        .upload-section {
            padding: 40px;
            text-align: center;
            border-bottom: 1px solid #2a2b31;
            background: #1a1b1f;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #1e1f23 0%, #252731 100%);
            color: #e6e6e6;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #3a3b41;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .file-input-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
            background: linear-gradient(135deg, #252731 0%, #2e3241 100%);
            border-color: #4a4b51;
        }

        .file-name {
            margin-top: 15px;
            color: #7a7a8a;
            font-style: italic;
        }

        .report-section {
            padding: 40px;
            display: none;
            background: #1a1b1f;
        }

        .summary-card {
            background: linear-gradient(135deg, #1e1f23 0%, #252731 100%);
            color: #e6e6e6;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            border: 1px solid #3a3b41;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(30, 31, 35, 0.6);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(58, 59, 65, 0.5);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .controls {
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .group-toggle, .sort-toggle {
            display: flex;
            background: #2a2b31;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #3a3b41;
        }

        .group-toggle button, .sort-toggle button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            color: #b3b3b3;
        }

        .group-toggle button.active, .sort-toggle button.active {
            background: #1e1f23;
            color: #e6e6e6;
            border: 1px solid #4a4b51;
        }

        .group-toggle button:hover:not(.active), .sort-toggle button:hover:not(.active) {
            background: #3a3b41;
            color: #e6e6e6;
        }

        .filter-section {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .filter-input {
            background: #2a2b31;
            border: 1px solid #3a3b41;
            border-radius: 6px;
            padding: 8px 12px;
            color: #e6e6e6;
            font-size: 0.85rem;
            min-width: 200px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #399ff6;
            box-shadow: 0 0 0 2px rgba(57, 159, 246, 0.2);
        }

        .filter-input::placeholder {
            color: #7a7a8a;
        }

        .clear-filter {
            background: #3a3b41;
            border: none;
            color: #b3b3b3;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .clear-filter:hover {
            background: #4a4b51;
            color: #e6e6e6;
        }

        .findings-section {
            margin-top: 30px;
        }

        .rule-group {
            background: #1e1f23;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            border: 1px solid #3a3b41;
        }

        .rule-header {
            padding: 15px 20px;
            background: #2a2b31;
            border-bottom: 1px solid #3a3b41;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .rule-header:hover {
            background: #3a3b41;
        }

        .rule-title {
            font-size: 1.1rem;
            color: #e6e6e6;
            margin-bottom: 6px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rule-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            color: #b3b3b3;
            font-size: 0.8rem;
            align-items: center;
        }

        .severity-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .severity-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .severity-info {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .findings-count {
            background: #1e1f23;
            color: #e6e6e6;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #4a4b51;
        }

        .toggle-icon {
            transition: transform 0.2s ease;
        }

        .rule-content {
            display: none;
            padding: 0 20px 20px 20px;
        }

        .rule-content.expanded {
            display: block;
        }

        .rule-content.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .rule-description {
            color: #b3b3b3;
            line-height: 1.5;
            margin-bottom: 15px;
            padding: 12px;
            background: #1a1b1f;
            border-radius: 8px;
            border-left: 4px solid #1e1f23;
            font-size: 0.85rem;
        }

        .finding-item {
            margin-bottom: 12px;
            border: 1px solid #3a3b41;
            border-radius: 8px;
            overflow: hidden;
            background: #1a1b1f;
        }

        .finding-summary {
            padding: 10px 12px;
            background: #2a2b31;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .finding-summary:hover {
            background: #3a3b41;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e6e6e6;
            font-size: 0.8rem;
        }

        .line-info {
            color: #7a7a8a;
            font-size: 0.75rem;
        }

        .finding-details {
            display: none;
            border-top: 1px solid #3a3b41;
            background: #1e1f23;
        }

        .finding-details.expanded {
            display: block;
        }

        .finding-content {
            padding: 15px;
        }

        .description {
            color: #b3b3b3;
            line-height: 1.5;
            margin-bottom: 12px;
            font-size: 0.85rem;
        }

        .code-section {
            margin-top: 12px;
        }

        .code-header {
            background: #2d3748;
            color: white;
            padding: 8px 12px;
            border-radius: 6px 6px 0 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-container {
            background: #1a202c;
            border-radius: 0 0 6px 6px;
            overflow: hidden;
        }

        .code-block {
            background: #1a202c;
            color: #e2e8f0;
            padding: 10px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.2;
            margin: 0;
        }

        .code-line {
            display: block;
            padding: 0;
            margin: 0;
        }

        .line-number {
            color: #718096;
            margin-right: 10px;
            min-width: 30px;
            display: inline-block;
            text-align: right;
        }

        .vulnerable-line {
            background: rgba(239, 68, 68, 0.2);
            border-left: 4px solid #ef4444;
            padding-left: 8px;
            margin-left: -8px;
        }

        .vulnerable-code {
            background: rgba(239, 68, 68, 0.3);
            color: #fed7d7;
            padding: 1px 3px;
            border-radius: 3px;
        }

        .no-findings {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-findings-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .powered-by {
                position: static;
                margin-top: 15px;
                justify-content: center;
            }

            .upload-section, .report-section {
                padding: 20px;
            }

            .rule-meta, .controls {
                flex-direction: column;
                gap: 10px;
            }

            .controls {
                align-items: flex-start;
            }

            .filter-section {
                margin-left: 0;
                width: 100%;
            }

            .filter-input {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="powered-by">
                Powered by <a href="https://inceite.com" target="_blank" rel="noopener">Inceite</a>
            </div>
            <div class="logo"></div>
            <h1>NeuroWall SarifViewer - Offline SARIF Security Report Viewer</h1>
            <p>View SARIF JSON files — generated by tools like SemGrep, OpenGrep, and NeuroWall Code Scanner — as clean, user-friendly HTML reports.</p>
        </div>

        <div class="upload-section">
            <div class="file-input-wrapper">
                <input type="file" id="sarifFile" class="file-input" accept=".sarif,.json">
                <button class="file-input-button">
                    📁 Choose SARIF File
                </button>
            </div>
            <div id="fileName" class="file-name"></div>
        </div>

        <div id="reportSection" class="report-section">
            <div id="summaryCard" class="summary-card">
                <h2>📊 Security Analysis Summary</h2>
                <div id="summaryGrid" class="summary-grid"></div>
            </div>

            <div class="controls">
                <label><strong>Group by:</strong></label>
                <div class="group-toggle">
                    <button id="groupByRule" class="active" onclick="setGroupMode('rule')">🔧 Detection Rule</button>
                    <button id="groupByFile" onclick="setGroupMode('file')">📄 Filename</button>
                </div>
                <label><strong>Sort by:</strong></label>
                <div class="sort-toggle">
                    <button id="sortByName" onclick="setSortMode('name')">🔤 Name</button>
                    <button id="sortBySeverity" class="active" onclick="setSortMode('severity')">⚠️ Severity</button>
                </div>
                
                <div class="filter-section">
                    <input type="text" id="filterInput" class="filter-input" placeholder="Filter by filename or vulnerability name...">
                    <button id="clearFilter" class="clear-filter" onclick="clearFilter()">✕ Clear</button>
                </div>
            </div>

            <div class="findings-section">
                <div id="findingsContainer"></div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('sarifFile');
        const fileName = document.getElementById('fileName');
        const reportSection = document.getElementById('reportSection');
        const summaryGrid = document.getElementById('summaryGrid');
        const findingsContainer = document.getElementById('findingsContainer');
        const filterInput = document.getElementById('filterInput');

        let currentFindings = [];
        let groupMode = 'rule';
        let sortMode = 'severity'; // Default to severity sorting
        let filterText = '';

        fileInput.addEventListener('change', handleFileSelect);
        filterInput.addEventListener('input', handleFilter);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            fileName.textContent = `Selected: ${file.name}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const sarifData = JSON.parse(e.target.result);
                    generateReport(sarifData);
                } catch (error) {
                    alert('Error parsing SARIF file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function handleFilter(event) {
            filterText = event.target.value.toLowerCase();
            if (currentFindings.length > 0) {
                displayFindings(currentFindings);
            }
        }

        function clearFilter() {
            filterInput.value = '';
            filterText = '';
            if (currentFindings.length > 0) {
                displayFindings(currentFindings);
            }
        }

        function setGroupMode(mode) {
            groupMode = mode;
            document.getElementById('groupByRule').classList.toggle('active', mode === 'rule');
            document.getElementById('groupByFile').classList.toggle('active', mode === 'file');
            
            if (currentFindings.length > 0) {
                displayFindings(currentFindings);
            }
        }

        function setSortMode(mode) {
            sortMode = mode;
            document.getElementById('sortByName').classList.toggle('active', mode === 'name');
            document.getElementById('sortBySeverity').classList.toggle('active', mode === 'severity');
            
            if (currentFindings.length > 0) {
                displayFindings(currentFindings);
            }
        }

        function generateReport(sarifData) {
            const runs = sarifData.runs || [];
            let allFindings = [];
            let uniqueRules = new Set();
            let severityCounts = { error: 0, warning: 0, info: 0 };

            // Process all runs
            runs.forEach(run => {
                const results = run.results || [];
                const rules = run.tool?.driver?.rules || [];
                const ruleMap = {};
                
                // Create rule lookup
                rules.forEach(rule => {
                    ruleMap[rule.id] = rule;
                });

                results.forEach(result => {
                    const rule = ruleMap[result.ruleId] || {};
                    const finding = {
                        ruleId: result.ruleId || 'unknown',
                        ruleName: rule.name || rule.shortDescription?.text || result.ruleId || 'Unknown Rule',
                        description: result.message?.text || rule.fullDescription?.text || 'No description available',
                        ruleDescription: rule.fullDescription?.text || rule.shortDescription?.text || 'No rule description available',
                        severity: getSeverity(result, rule),
                        locations: result.locations || [],
                        uri: result.locations?.[0]?.physicalLocation?.artifactLocation?.uri || 'Unknown file',
                        line: result.locations?.[0]?.physicalLocation?.region?.startLine || null
                    };

                    allFindings.push(finding);
                    uniqueRules.add(result.ruleId);
                    severityCounts[finding.severity]++;
                });
            });

            currentFindings = allFindings;

            // Generate summary
            generateSummary(allFindings.length, uniqueRules.size, severityCounts);

            // Display findings
            displayFindings(allFindings);

            // Show report
            reportSection.style.display = 'block';
        }

        function getSeverity(result, rule) {
            if (result.level) {
                switch (result.level) {
                    case 'error': return 'error';
                    case 'warning': return 'warning';
                    case 'note':
                    case 'info': return 'info';
                    default: return 'info';
                }
            }
            
            if (rule.defaultConfiguration?.level) {
                switch (rule.defaultConfiguration.level) {
                    case 'error': return 'error';
                    case 'warning': return 'warning';
                    case 'note':
                    case 'info': return 'info';
                    default: return 'info';
                }
            }

            return 'info';
        }

        function generateSummary(totalFindings, uniqueRules, severityCounts) {
            summaryGrid.innerHTML = `
                <div class="stat-box">
                    <span class="stat-number">${totalFindings}</span>
                    <span class="stat-label">Total Findings</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number">${uniqueRules}</span>
                    <span class="stat-label">Unique Rules</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number">${severityCounts.error}</span>
                    <span class="stat-label">Errors</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number">${severityCounts.warning}</span>
                    <span class="stat-label">Warnings</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number">${severityCounts.info}</span>
                    <span class="stat-label">Info</span>
                </div>
            `;
        }

        function filterFindings(findings) {
            if (!filterText) return findings;
            
            return findings.filter(finding => {
                return finding.uri.toLowerCase().includes(filterText) ||
                       finding.ruleName.toLowerCase().includes(filterText) ||
                       finding.ruleId.toLowerCase().includes(filterText) ||
                       finding.description.toLowerCase().includes(filterText);
            });
        }

        function displayFindings(findings) {
            const filteredFindings = filterFindings(findings);
            
            if (filteredFindings.length === 0) {
                findingsContainer.innerHTML = `
                    <div class="no-findings">
                        <div class="no-findings-icon">${filterText ? '🔍' : '✅'}</div>
                        <h3>${filterText ? 'No Matching Results' : 'No Security Findings'}</h3>
                        <p>${filterText ? 'Try adjusting your search terms.' : 'Great! No security issues were found in the analyzed code.'}</p>
                    </div>
                `;
                return;
            }

            if (groupMode === 'rule') {
                displayFindingsByRule(filteredFindings);
            } else {
                displayFindingsByFile(filteredFindings);
            }
        }

        function displayFindingsByRule(findings) {
            const groupedByRule = {};
            
            findings.forEach(finding => {
                if (!groupedByRule[finding.ruleId]) {
                    groupedByRule[finding.ruleId] = {
                        ruleName: finding.ruleName,
                        ruleDescription: finding.ruleDescription,
                        severity: finding.severity,
                        findings: []
                    };
                }
                groupedByRule[finding.ruleId].findings.push(finding);
            });

            // Sort groups
            const sortedRuleIds = Object.keys(groupedByRule).sort((a, b) => {
                if (sortMode === 'severity') {
                    const severityOrder = { 'error': 0, 'warning': 1, 'info': 2 };
                    const severityA = severityOrder[groupedByRule[a].severity];
                    const severityB = severityOrder[groupedByRule[b].severity];
                    if (severityA !== severityB) return severityA - severityB;
                }
                // Default to name sorting or fallback
                return groupedByRule[a].ruleName.localeCompare(groupedByRule[b].ruleName);
            });

            findingsContainer.innerHTML = sortedRuleIds.map((ruleId, groupIndex) => {
                const group = groupedByRule[ruleId];
                return `
                    <div class="rule-group">
                        <div class="rule-header" onclick="toggleRuleGroup(${groupIndex})">
                            <div class="rule-title">
                                <span>${escapeHtml(group.ruleName)}</span>
                                <span class="toggle-icon">▼</span>
                            </div>
                            <div class="rule-meta">
                                <span class="severity-badge severity-${group.severity}">${group.severity}</span>
                                <span class="findings-count">${group.findings.length} finding${group.findings.length > 1 ? 's' : ''}</span>
                                <span>🔧 ${escapeHtml(ruleId)}</span>
                            </div>
                        </div>
                        <div id="rule-content-${groupIndex}" class="rule-content">
                            <div class="rule-description">${escapeHtml(group.ruleDescription)}</div>
                            ${group.findings.map((finding, findingIndex) => 
                                generateFindingItem(finding, `${groupIndex}-${findingIndex}`)
                            ).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayFindingsByFile(findings) {
            const groupedByFile = {};
            
            findings.forEach(finding => {
                if (!groupedByFile[finding.uri]) {
                    groupedByFile[finding.uri] = [];
                }
                groupedByFile[finding.uri].push(finding);
            });

            // Sort groups
            const sortedFiles = Object.keys(groupedByFile).sort((a, b) => {
                if (sortMode === 'severity') {
                    const severityOrder = { 'error': 0, 'warning': 1, 'info': 2 };
                    const getHighestSeverity = (findings) => {
                        return findings.reduce((highest, finding) => {
                            const currentSeverity = severityOrder[finding.severity];
                            const highestSeverity = severityOrder[highest];
                            return currentSeverity < highestSeverity ? finding.severity : highest;
                        }, 'info');
                    };
                    
                    const severityA = severityOrder[getHighestSeverity(groupedByFile[a])];
                    const severityB = severityOrder[getHighestSeverity(groupedByFile[b])];
                    if (severityA !== severityB) return severityA - severityB;
                }
                // Default to filename sorting or fallback
                return a.localeCompare(b);
            });

            findingsContainer.innerHTML = sortedFiles.map((uri, groupIndex) => {
                const fileFindings = groupedByFile[uri];
                const severityCounts = fileFindings.reduce((acc, f) => {
                    acc[f.severity] = (acc[f.severity] || 0) + 1;
                    return acc;
                }, {});
                
                return `
                    <div class="rule-group">
                        <div class="rule-header" onclick="toggleRuleGroup(${groupIndex})">
                            <div class="rule-title">
                                <span>📄 ${escapeHtml(uri)}</span>
                                <span class="toggle-icon">▼</span>
                            </div>
                            <div class="rule-meta">
                                <span class="findings-count">${fileFindings.length} finding${fileFindings.length > 1 ? 's' : ''}</span>
                                ${Object.keys(severityCounts).map(sev => 
                                    `<span class="severity-badge severity-${sev}">${sev}: ${severityCounts[sev]}</span>`
                                ).join('')}
                            </div>
                        </div>
                        <div id="rule-content-${groupIndex}" class="rule-content">
                            ${fileFindings.map((finding, findingIndex) => 
                                generateFindingItem(finding, `${groupIndex}-${findingIndex}`)
                            ).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateFindingItem(finding, id) {
            const location = finding.locations[0]?.physicalLocation;
            const region = location?.region;
            
            return `
                <div class="finding-item">
                    <div class="finding-summary" onclick="toggleFindingDetails('${id}')">
                        <div class="file-info">
                            <span class="severity-badge severity-${finding.severity}">${finding.severity}</span>
                            <span>${groupMode === 'rule' ? '📄 ' + escapeHtml(finding.uri) : '🔧 ' + escapeHtml(finding.ruleId)}</span>
                            ${region ? `<span class="line-info">Line ${region.startLine}${region.endLine && region.endLine !== region.startLine ? `-${region.endLine}` : ''}</span>` : ''}
                        </div>
                        <span class="toggle-icon">▶</span>
                    </div>
                    <div id="finding-details-${id}" class="finding-details">
                        <div class="finding-content">
                            <div class="description">${escapeHtml(finding.description)}</div>
                            ${generateCodeSection(location)}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateCodeSection(location) {
            if (!location) return '';

            const region = location.region;
            const contextRegion = location.contextRegion;
            
            if (!contextRegion && !region) return '';

            const snippet = contextRegion?.snippet?.text || region?.snippet?.text;
            if (!snippet) return '';

            const startLine = contextRegion?.startLine || region?.startLine || 1;
            const vulnerableLine = region?.startLine || startLine;
            const vulnerableColumn = region?.startColumn || 1;
            const vulnerableEndColumn = region?.endColumn || vulnerableColumn;

            const lines = snippet.split('\n');
            const codeLines = lines.map((line, index) => {
                const lineNumber = startLine + index;
                const isVulnerable = lineNumber === vulnerableLine;
                
                let processedLine = escapeHtml(line);
                
                if (isVulnerable && vulnerableColumn && vulnerableEndColumn) {
                    const beforeVuln = processedLine.substring(0, vulnerableColumn - 1);
                    const vulnCode = processedLine.substring(vulnerableColumn - 1, vulnerableEndColumn);
                    const afterVuln = processedLine.substring(vulnerableEndColumn);
                    processedLine = beforeVuln + `<span class="vulnerable-code">${vulnCode}</span>` + afterVuln;
                }

                return `<span class="code-line ${isVulnerable ? 'vulnerable-line' : ''}"><span class="line-number">${lineNumber}</span>${processedLine}</span>`;
            }).join('\n');

            return `
                <div class="code-section">
                    <div class="code-header">
                        <span>💻 Code Context</span>
                        <span>Line ${vulnerableLine}</span>
                    </div>
                    <div class="code-container">
                        <pre class="code-block">${codeLines}</pre>
                    </div>
                </div>
            `;
        }

        function toggleRuleGroup(index) {
            const content = document.getElementById(`rule-content-${index}`);
            const icon = content.previousElementSibling.querySelector('.toggle-icon');
            
            content.classList.toggle('expanded');
            icon.style.transform = content.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function toggleFindingDetails(id) {
            const details = document.getElementById(`finding-details-${id}`);
            const icon = details.previousElementSibling.querySelector('.toggle-icon');
            
            details.classList.toggle('expanded');
            icon.textContent = details.classList.contains('expanded') ? '▼' : '▶';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>